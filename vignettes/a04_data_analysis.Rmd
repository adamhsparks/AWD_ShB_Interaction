---
title: "Sheath Blight Analysis"
author: "A. H. Sparks"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    theme: journal
vignette: >
  %\VignetteIndexEntry{Sheath Blight Analysis}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

Based on the residual plots where several do not meet assumptions for a normal distribution, I've elected to use a naive Bayesian approach using the _brms_ package's `brm()` for a split plot analysis rather than a `lmer()` model.

# Interpreting These Analyses

When comparing the treatments in the analysis, the model compares each treatment to the base (control) treatment.

The base levels for this analysis are:

- 2015 
  
    - `NRTE:0`

    - `WMGT:PDL`

- 2016

    - `NRTE:60`

    - `WMGT:PDL`

### Changes between 2015 and 2016

Before the analysis, note that due to changes between the years, the analysis must be carried out on each year separately.
The 2015 data and 2016 data cannot be combined due to changes in inoculation methods; there are other changes too, but the main one is this.
Therefore, the analyses will be conducted separately such that comparisons will only be observational and cannot be statistically compared.

# Setup

```{r set_seed, message=FALSE}
library("brms")
library("dplyr")
library("rice.awd.shb")
library("ggplot2")
theme_set(theme_minimal())
```

The `AUDPS` object is loaded with the `rice.awd.shb` R package. To see how the AUDPS data were generated from the original raw data, see the [vignette detailing the data processing](a02_Data_preprocessing.html) file.
However, because it is a `tibble()` and the treatments exist in a single column for graphing the raw data, this object needs a few minor changes to be usable for the analysis.

Create individual data frames for the analysis.

```{r create_analysis_df, cache=FALSE, message=FALSE}
# create 2015 data frame
AUDPS_2015 <- as.data.frame(AUDPS[AUDPS$YEAR == 2015, ])
AUDPS_2015 <- droplevels(AUDPS_2015)

# relevel factors for easier interpretation of analysis
AUDPS_2015 <- within(AUDPS_2015, NRTE <- relevel(NRTE, ref = "N0"))
AUDPS_2015 <- within(AUDPS_2015, WMGT <- relevel(WMGT, ref = "PDL"))

# create 2016 data frame
AUDPS_2016 <- as.data.frame(AUDPS[AUDPS$YEAR == 2016, ])
AUDPS_2016 <- droplevels(AUDPS_2016)

# relevel factors for easier interpretation of analysis
AUDPS_2016 <- within(AUDPS_2016, NRTE <- relevel(NRTE, ref = "N60"))
AUDPS_2016 <- within(AUDPS_2016, WMGT <- relevel(WMGT, ref = "PDL"))
```

Now that the `AUDPS_2015` and `AUDPS_2016` `data.frames()` exist, we can start
the analysis.

# Check Correlation

Check for correlation between the tiller incidence and the severity ratings for both leaf and tiller.

```{r correlation}
# 2015 Tiller Severity Correlation
cor.test(AUDPS_2015$TShB_incidence_AUDPS,
         AUDPS_2015$TShB_percent_AUDPS,
         method = "spearman",
         alternative = "two.sided",
         exact = FALSE)

# 2015 Leaf Severity Correlation
cor.test(AUDPS_2015$TShB_incidence_AUDPS,
         AUDPS_2015$LShB_percent_AUDPS,
         method = "spearman",
         alternative = "two.sided",
         exact = FALSE)

# 2016 Tiller Severity Correlation
cor.test(AUDPS_2016$TShB_incidence_AUDPS,
         AUDPS_2016$TShB_percent_AUDPS,
         method = "spearman",
         alternative = "two.sided",
         exact = FALSE)

# 2016 Leaf Severity Correlation
cor.test(AUDPS_2016$TShB_incidence_AUDPS,
         AUDPS_2016$LShB_percent_AUDPS,
         method = "spearman",
         alternative = "two.sided",
         exact = FALSE)
```

The tiller incidence of the disease appears not to be correlated with the severity on the tiller or the leaves.
Based on this, the interactions of the incidence and severity will not be analysed.

# 2015 Models

## 2015 Tiller Sheath Blight Incidence Model

### Model Structure

Tiller sheath blight incidence AUDPS, `TShB_incidence_AUDPS` is the response variable.
The interaction of water management, `WMGT`, and nitrogen rate, `NRTE`, are fixed effects.
Replicate, `REP`, is treated as a random effect.

```{r 2015_TShB_incidence, cache=FALSE}
m1 <- brm(
  formula = TShB_incidence_AUDPS ~ WMGT * NRTE + (1 | REP),
  data    = AUDPS_2015,
  seed    = 27,
  control = list(adapt_delta = 0.999),
  iter = 5000
)

summary(m1)

prior_summary(m1)

plot(m1)

conditional_effects(m1)
```

## 2015 Tiller Sheath Blight Severity Model

### Model Structure

Tiller sheath blight severity AUDPS, `TShB_percent_AUDPS` is the response variable.
The interaction of water management, `WMGT`, and nitrogen rate, `NRTE`, are fixed effects.
Replicate, `REP` is treated as a random effect.

```{r 2015_TShB_severity, cache=FALSE}
m2 <- brm(
  formula = TShB_percent_AUDPS ~ WMGT * NRTE + (1 | REP),
  data    = AUDPS_2015,
  seed    = 27,
  control = list(adapt_delta = 0.999),
  prior = set_prior("normal(0, 3)"),
  iter = 5000
)

summary(m2)

prior_summary(m2)

plot(m2)

conditional_effects(m2)
```

## 2015 Leaf Sheath Blight Severity Model

### Model Structure

Leaf sheath blight severity AUDPS, `LShB_percent_AUDPS` is the response variable.
The interaction of water management, `WMGT`, and nitrogen rate, `NRTE`, are fixed effects.
Replicate, `REP` is treated as a random effect.

```{r 2015_LShB_severity, cache=FALSE}
m3 <- brm(
  formula = LShB_percent_AUDPS ~ WMGT * NRTE + (1 | REP),
  data = AUDPS_2015,
  seed = 27,
  control = list(adapt_delta = 0.999),
  prior = set_prior("normal(0, 3)"),
  iter = 5000
)

summary(m3)

prior_summary(m3)

plot(m3)

conditional_effects(m3)
```

*******

# 2016 Models

## 2016 Tiller Sheath Blight Incidence Model

### Model Structure

Tiller sheath blight incidence AUDPS, `TShB_incidence_AUDPS` is the response variable.
The interaction of water management, `WMGT`, and nitrogen rate, `NRTE`, are fixed effects.
Replicate, `REP` is treated as a random effect.

```{r 2016_TShB_incidence, cache=FALSE}
m4 <- brm(
  formula = TShB_incidence_AUDPS ~ WMGT * NRTE + (1 | REP),
  data = AUDPS_2016,
  seed = 27,
  control = list(adapt_delta = 0.999),
  prior = set_prior("normal(0, 3)"),
  iter = 5000
)

summary(m4)

prior_summary(m4)

plot(m4)

conditional_effects(m4)
```


## 2016 Tiller Sheath Blight Severity Model

### Model Structure

Tiller sheath blight severity AUDPS, `TShB_percent_AUDPS` is the response variable.
The interaction of water management, `WMGT`, and nitrogen rate, `NRTE`, are fixed effects.
Replicate, `REP` is treated as a random effect.

```{r 2016_TShB_severity, cache=FALSE}
m5 <- brm(
  formula = TShB_percent_AUDPS ~ WMGT * NRTE + (1 | REP),
  data = AUDPS_2016,
  seed = 27,
  control = list(adapt_delta = 0.999),
  prior = set_prior("normal(0, 3)"),
  iter = 5000
)

summary(m5)

prior_summary(m5)

plot(m5)

conditional_effects(m5)
```

## 2016 Leaf Sheath Blight Severity Model

### Model Structure

Leaf sheath blight severity AUDPS, `LShB_percent_AUDPS` is the response variable.
The interaction of water management, `WMGT`, and nitrogen rate, `NRTE`, are fixed effects.
Replicate, `REP` is treated as a random effect.

```{r 2016_LShB_severity, cache=FALSE}
m6 <- brm(
  formula = LShB_percent_AUDPS ~ WMGT * NRTE + (1 | REP),
  data = AUDPS_2016,
  seed = 27,
  control = list(adapt_delta = 0.999),
  prior = set_prior("normal(0, 3)"),
  iter = 5000
)

summary(m6)

prior_summary(m6)

plot(m6)

conditional_effects(m6)
```

## Model Fit

The models all appear to be good fits.

None of the diagnostic plots show any signs of auto-correlation or any other obvious patterns that would indicate issues with the models.

## Conclusions

### Tiller Sheath Blight Incidence

## Tiller Sheath Blight Severity

## Leaf Sheath Blight Severity

# Save Model Information

Lastly, save the model information used in the posterior estimate graphs to be used in the paper.

```{r save_models}
models <- list(
  "TInc_15" = m1,
  "TSev_15" = m2,
  "LSev_15" = m3,
  "TInc_16" = m4,
  "TSev_16" = m5,
  "LSev_16" = m6
)
saveRDS(models, "../analysis/data/derived_data/models.Rds")
```
